# ğŸ“š Ù…Ø³ØªÙ†Ø¯Ø§Øª Ú©Ø§Ù…Ù„ Ø³ÛŒØ³ØªÙ…

## ğŸ¤– Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù…

### ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ

#### Ù…Ø¯ÛŒØ±ÛŒØª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
- Ø¢Ù¾Ù„ÙˆØ¯ Ùˆ Ø°Ø®ÛŒØ±Ù‡ ÙØ§ÛŒÙ„ Ø¯Ø± Ú©Ø§Ù†Ø§Ù„ ØªÙ„Ú¯Ø±Ø§Ù…
- Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ù‡ÛŒØ±Ø§Ø±Ø´ÛŒÚ© ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
- Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¯Ø± ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
- Ø­Ø°Ù Ùˆ ÙˆÛŒØ±Ø§ÛŒØ´ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
- Ø§Ù†ØªÙ‚Ø§Ù„ ÙØ§ÛŒÙ„ Ø¨ÛŒÙ† Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§

#### Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§
- Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒ Ú†Ù†Ø¯Ø³Ø·Ø­ÛŒ
- ÙˆÛŒØ±Ø§ÛŒØ´ Ù†Ø§Ù… Ùˆ ØªÙˆØ¶ÛŒØ­Ø§Øª Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§
- Ø­Ø°Ù Ø¯Ø³ØªÙ‡ (Ø¨Ø§ Ø§Ø­ØªÛŒØ§Ø·)
- Ø¢ÛŒÚ©ÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø³ÙØ§Ø±Ø´ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§

#### Ø³ÛŒØ³ØªÙ… Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ
- Ø§ÛŒØ¬Ø§Ø¯ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ø§Ø´ØªØ±Ø§Ú© Ø¨Ø±Ø§ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
- Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ø¯Ø³ØªÙ‡â€ŒØ§ÛŒ (ØªÙ…Ø§Ù… ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¯Ø³ØªÙ‡)
- Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ù…Ø¬Ù…ÙˆØ¹Ù‡â€ŒØ§ÛŒ (ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ)
- Ú©Ù†ØªØ±Ù„ Ø¯Ø³ØªØ±Ø³ÛŒ Ùˆ Ø¢Ù…Ø§Ø±

#### Ø¨Ø±ÙˆØ¯Ú©Ø³Øª
- Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ù…ØªÙ†ÛŒ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
- Ø¨Ø±ÙˆØ¯Ú©Ø³Øª ÙØ§ÛŒÙ„
- Ø¢Ù…Ø§Ø± Ø§Ø±Ø³Ø§Ù„

### Ú©Ø§Ù…Ù¾ÙˆÙ†Ù†Øªâ€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ

#### DatabaseManager (`/app/bot/database/db_manager.py`)
```python
class DatabaseManager:
    async def get_categories(self, parent_id=None)
    async def create_category(self, name, parent_id, description)
    async def get_files(self, category_id, limit=20)
    async def create_file_record(self, file_data)
    async def create_link(self, link_data)
```

#### Handlers
- `CategoryHandler`: Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø³ØªÙ‡â€ŒÙ‡Ø§
- `FileHandler`: Ù…Ø¯ÛŒØ±ÛŒØª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
- `MessageHandler`: Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
- `BroadcastHandler`: Ø³ÛŒØ³ØªÙ… Ø¨Ø±ÙˆØ¯Ú©Ø³Øª
- `DownloadSystemHandler`: Ø§Ø¯ØºØ§Ù… Ø¨Ø§ Ø³ÛŒØ³ØªÙ… Ø¯Ø§Ù†Ù„ÙˆØ¯

### ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ù‡Ù…

```python
# /app/bot/config/settings.py
BOT_TOKEN = "YOUR_BOT_TOKEN"
STORAGE_CHANNEL_ID = -1002546879743
MAX_FILE_SIZE = 50 * 1024 * 1024  # 50MB
```

## ğŸŒ Ø³ÛŒØ³ØªÙ… Ø¯Ø§Ù†Ù„ÙˆØ¯

### ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ

#### Ø§Ù†ÙˆØ§Ø¹ Ø¯Ø§Ù†Ù„ÙˆØ¯
1. **Stream Download**
   - Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ø¯ÙˆÙ† Ø°Ø®ÛŒØ±Ù‡
   - Ù…Ù†Ø§Ø³Ø¨ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¨Ø²Ø±Ú¯
   - Ú©Ù…â€ŒØªØ±ÛŒÙ† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù…Ù†Ø§Ø¨Ø¹

2. **Fast Download**
   - Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± cache Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯Ù‡Ø§ÛŒ Ø¨Ø¹Ø¯ÛŒ
   - Ø³Ø±Ø¹Øª Ø¨Ø§Ù„Ø§ Ø¨Ø±Ø§ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ
   - Ù…Ø¯ÛŒØ±ÛŒØª Ø®ÙˆØ¯Ú©Ø§Ø± cache

3. **Restricted Download**
   - Ú©Ù†ØªØ±Ù„ ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ù†Ù„ÙˆØ¯
   - ØªÙ†Ø¸ÛŒÙ… Ø²Ù…Ø§Ù† Ø§Ù†Ù‚Ø¶Ø§
   - Ù…Ø­Ø¯ÙˆØ¯ÛŒØª IP
   - Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø®ØªÛŒØ§Ø±ÛŒ

#### Ù…Ø¯ÛŒØ±ÛŒØª Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§
- Ø§ÛŒØ¬Ø§Ø¯ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙ‚Øª
- Ø±Ø¯ÛŒØ§Ø¨ÛŒ Ø¢Ù…Ø§Ø± Ø¯Ø§Ù†Ù„ÙˆØ¯
- ØºÛŒØ±ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§
- ÙˆØ¨â€ŒÙ‡ÙˆÚ© Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ

### Ù…Ø¹Ù…Ø§Ø±ÛŒ Ø³ÛŒØ³ØªÙ…

#### Core Components

##### DatabaseManager (`/app/download_system/core/database.py`)
```python
class DatabaseManager:
    async def create_download_link(self, link: DownloadLink)
    async def get_download_link(self, link_code: str)
    async def get_download_stats(self, link_code: str)
    async def cleanup_expired_cache(self)
```

##### AuthManager (`/app/download_system/core/auth.py`)
```python
class AuthManager:
    async def create_token(self, name, permissions, ...)
    async def validate_token(self, token_string)
    def check_permission(self, token, permission)
```

##### DownloadManager (`/app/download_system/core/download_manager.py`)
```python
class DownloadManager:
    async def create_download_link(self, file_id, download_type, ...)
    async def stream_download(self, file_id, storage_message_id)
    async def fast_download(self, file_id, file_name, ...)
    async def validate_download_access(self, link_code, ip, password)
```

#### API Routes

##### Authentication (`/api/auth`)
- `POST /api/auth/token` - Ø§ÛŒØ¬Ø§Ø¯ ØªÙˆÚ©Ù† Ø¬Ø¯ÛŒØ¯
- `GET /api/auth/validate` - Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ØªÙˆÚ©Ù†

##### Download (`/api/download`)
- `POST /api/download/links/create` - Ø§ÛŒØ¬Ø§Ø¯ Ù„ÛŒÙ†Ú© Ø¯Ø§Ù†Ù„ÙˆØ¯
- `GET /api/download/stream/{link_code}` - Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§Ø³ØªØ±ÛŒÙ…
- `GET /api/download/fast/{link_code}` - Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø³Ø±ÛŒØ¹
- `GET /api/download/info/{link_code}` - Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù„ÛŒÙ†Ú©
- `GET /api/download/stats/{link_code}` - Ø¢Ù…Ø§Ø± Ù„ÛŒÙ†Ú©

##### Files (`/api/files`)
- `GET /api/files/info/{file_id}` - Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ§ÛŒÙ„
- `GET /api/files/category/{category_id}` - ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¯Ø³ØªÙ‡
- `GET /api/files/search` - Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± ÙØ§ÛŒÙ„â€ŒÙ‡Ø§

##### System (`/api/system`)
- `GET /api/system/health` - ÙˆØ¶Ø¹ÛŒØª Ø³ÛŒØ³ØªÙ…
- `GET /api/system/metrics` - Ø¢Ù…Ø§Ø± Ø¹Ù…Ù„Ú©Ø±Ø¯
- `POST /api/system/cache/cleanup` - Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ cache

##### Admin (`/api/admin`)
- `GET /api/admin/stats/system` - Ø¢Ù…Ø§Ø± Ú©Ø§Ù…Ù„ Ø³ÛŒØ³ØªÙ…
- `GET /api/admin/downloads/active` - Ø¯Ø§Ù†Ù„ÙˆØ¯Ù‡Ø§ÛŒ ÙØ¹Ø§Ù„
- `POST /api/admin/cache/clear` - Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ cache

### Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø¯Ù‡

#### Token
```python
class Token(BaseModel):
    id: str
    token_hash: str
    name: str
    token_type: TokenType
    permissions: str  # JSON
    expires_at: Optional[datetime]
    is_active: bool
```

#### DownloadLink
```python
class DownloadLink(BaseModel):
    link_code: str
    file_id: int
    download_type: DownloadType
    max_downloads: Optional[int]
    expires_at: Optional[datetime]
    password_hash: Optional[str]
    download_count: int
```

#### DownloadSession
```python
class DownloadSession(BaseModel):
    link_code: str
    file_id: int
    ip_address: str
    file_size: int
    downloaded_bytes: int
    status: DownloadStatus
```

### ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÛŒØ³ØªÙ…

```python
# /app/download_system/config/settings.py
class Settings(BaseSettings):
    API_HOST: str = "0.0.0.0"
    API_PORT: int = 8001
    SECRET_KEY: str
    DATABASE_URL: str
    MAX_CACHE_SIZE: int = 5 * 1024 * 1024 * 1024  # 5GB
    RATE_LIMIT_PER_MINUTE: int = 60
```

## ğŸ”— Ø§Ø¯ØºØ§Ù… Ø³ÛŒØ³ØªÙ…â€ŒÙ‡Ø§

### DownloadSystemHandler Ø¯Ø± Ø±Ø¨Ø§Øª

```python
class DownloadSystemHandler(BaseHandler):
    def __init__(self, db, download_api_url, admin_token):
        self.api_url = download_api_url  # http://localhost:8001
        self.admin_token = admin_token
        self.headers = {"Authorization": f"Bearer {admin_token}"}
    
    async def show_file_download_options(self, update, context):
        # Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¨Ø±Ø§ÛŒ ÙØ§ÛŒÙ„
    
    async def create_stream_link(self, update, context):
        # Ø§ÛŒØ¬Ø§Ø¯ Ù„ÛŒÙ†Ú© Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§Ø³ØªØ±ÛŒÙ…
    
    async def create_fast_link(self, update, context):
        # Ø§ÛŒØ¬Ø§Ø¯ Ù„ÛŒÙ†Ú© Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø³Ø±ÛŒØ¹
    
    async def create_restricted_link(self, update, context):
        # Ø§ÛŒØ¬Ø§Ø¯ Ù„ÛŒÙ†Ú© Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù…Ø­Ø¯ÙˆØ¯
```

### ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ API

```python
async def create_download_link_via_api(self, link_data: dict):
    async with aiohttp.ClientSession() as session:
        async with session.post(
            f"{self.api_url}/api/download/links/create",
            headers=self.headers,
            json=link_data
        ) as response:
            return await response.json()
```

## ğŸ›  ØªÙˆØ³Ø¹Ù‡ Ùˆ Ø³ÙØ§Ø±Ø´ÛŒâ€ŒØ³Ø§Ø²ÛŒ

### Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Handler Ø¬Ø¯ÛŒØ¯

1. Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù„Ø§Ø³ Ø¬Ø¯ÛŒØ¯ Ø¯Ø± `/app/bot/handlers/`
2. Ø§Ø±Ø«â€ŒØ¨Ø±ÛŒ Ø§Ø² `BaseHandler`
3. ØªØ¹Ø±ÛŒÙ Ù…ØªØ¯Ù‡Ø§ÛŒ async
4. Ø«Ø¨Øª Ø¯Ø± `bot_main.py`

```python
class CustomHandler(BaseHandler):
    async def handle_custom_action(self, update, context):
        # Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯
        pass
```

### Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† API Route Ø¬Ø¯ÛŒØ¯

1. Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ Ø¯Ø± `/app/download_system/api/routes/`
2. ØªØ¹Ø±ÛŒÙ router
3. Ø«Ø¨Øª Ø¯Ø± `main.py`

```python
# custom_route.py
from fastapi import APIRouter

router = APIRouter()

@router.get("/custom")
async def custom_endpoint():
    return {"message": "Custom endpoint"}

# main.py
from api.routes import custom_route
app.include_router(custom_route.router, prefix="/api/custom")
```

### Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù…Ø¯Ù„ Ø¯Ø§Ø¯Ù‡ Ø¬Ø¯ÛŒØ¯

```python
# Ø¯Ø± core/models.py
class CustomModel(BaseModel):
    id: str
    name: str
    created_at: datetime

# Ø¯Ø± core/database.py
async def create_custom_record(self, data: CustomModel):
    # Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³
    pass
```

## ğŸ“Š Ù†Ø¸Ø§Ø±Øª Ùˆ Ø¹Ù…Ù„Ú©Ø±Ø¯

### Ù…ØªØ±ÛŒÚ©â€ŒÙ‡Ø§ÛŒ Ù…Ù‡Ù…

1. **Ø³ÛŒØ³ØªÙ… Ø¹Ù…ÙˆÙ…ÛŒ**
   - ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙØ¹Ø§Ù„
   - ØªØ¹Ø¯Ø§Ø¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡
   - Ø­Ø¬Ù… Ú©Ù„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§

2. **Ø¯Ø§Ù†Ù„ÙˆØ¯Ù‡Ø§**
   - ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ù†Ù„ÙˆØ¯Ù‡Ø§ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡
   - Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø³Ø±Ø¹Øª Ø¯Ø§Ù†Ù„ÙˆØ¯
   - Ù†Ø±Ø® Ù…ÙˆÙÙ‚ÛŒØª

3. **Cache**
   - Ø¯Ø±ØµØ¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² cache
   - Hit rate
   - ÙØ¶Ø§ÛŒ Ù…ØµØ±ÙÛŒ

### Ù„Ø§Ú¯â€ŒÙ‡Ø§

```bash
# Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø±Ø¨Ø§Øª
tail -f /var/log/supervisor/bot.out.log

# Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ… Ø¯Ø§Ù†Ù„ÙˆØ¯
tail -f /var/log/supervisor/download_system.out.log

# Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ supervisor
tail -f /var/log/supervisor/supervisord.log
```

### Ø¨Ú©â€ŒØ¢Ù¾ Ùˆ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ

```bash
# Ø¨Ú©â€ŒØ¢Ù¾ Ø¯ÛŒØªØ§Ø¨ÛŒØ³â€ŒÙ‡Ø§
cp /app/bot/bot_database.db /backup/
cp /app/download_system/download_system.db /backup/

# Ø¨Ú©â€ŒØ¢Ù¾ ØªÙ†Ø¸ÛŒÙ…Ø§Øª
cp /app/bot/config/settings.py /backup/
cp /app/download_system/.env /backup/
```

## ğŸ”’ Ø§Ù…Ù†ÛŒØª Ùˆ Ø¨Ù‡ØªØ±ÛŒÙ† Ø´ÛŒÙˆÙ‡â€ŒÙ‡Ø§

### Ù…Ø¯ÛŒØ±ÛŒØª ØªÙˆÚ©Ù†â€ŒÙ‡Ø§
- Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ Ù‚ÙˆÛŒ
- ØªÙ†Ø¸ÛŒÙ… Ø²Ù…Ø§Ù† Ø§Ù†Ù‚Ø¶Ø§ Ù…Ù†Ø§Ø³Ø¨
- Ù…Ø­Ø¯ÙˆØ¯ÛŒØª permissions
- Ù†Ø¸Ø§Ø±Øª Ø¨Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡

### Ù…Ø­Ø§ÙØ¸Øª Ø§Ø² API
- Rate limiting
- Input validation
- SQL injection prevention
- XSS protection

### Ù…Ø­Ø§ÙØ¸Øª Ø§Ø² Ø¯ÛŒØªØ§Ø¨ÛŒØ³
- Backup Ù…Ù†Ø¸Ù…
- Ø±Ù…Ø²Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø­Ø³Ø§Ø³
- Ú©Ù†ØªØ±Ù„ Ø¯Ø³ØªØ±Ø³ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
- Audit trail

Ø§ÛŒÙ† Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø´Ø§Ù…Ù„ ØªÙ…Ø§Ù… Ø¬Ù†Ø¨Ù‡â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ… Ø¨Ø±Ø§ÛŒ ØªÙˆØ³Ø¹Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ú¯Ø§Ù† Ùˆ Ù…Ø¯ÛŒØ±Ø§Ù† Ø³ÛŒØ³ØªÙ… Ø§Ø³Øª.