#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
Token Management Handler - Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù…Ù„ Ø³ÛŒØ³ØªÙ… ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ
"""

import aiohttp
import asyncio
import json
import logging
from typing import Dict, Any, List, Optional
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes
from datetime import datetime, timedelta

from handlers.base_handler import BaseHandler

logger = logging.getLogger(__name__)


class TokenManagementHandler(BaseHandler):
    """Ù…Ø¯ÛŒØ±ÛŒØª Ù¾ÛŒØ´Ø±ÙØªÙ‡ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ"""
    
    def __init__(self, db, download_api_url: str, admin_token: str):
        super().__init__(db)
        self.api_url = download_api_url
        self.admin_token = admin_token
        self.headers = {"Authorization": f"Bearer {admin_token}"}
    
    async def show_token_dashboard(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØª ØªÙˆÚ©Ù†â€ŒÙ‡Ø§"""
        try:
            query = update.callback_query
            await query.answer()
            
            # Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø± ØªÙˆÚ©Ù†â€ŒÙ‡Ø§
            stats = await self.get_token_statistics()
            
            text = "ğŸ”— **Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØª ØªÙˆÚ©Ù†â€ŒÙ‡Ø§**\n\n"
            
            if stats.get('success'):
                data = stats.get('data', {})
                text += f"ğŸ“Š **Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ:**\n"
                text += f"â€¢ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„: {data.get('active_tokens', 0)}\n"
                text += f"â€¢ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ Ù…Ù†Ù‚Ø¶ÛŒ: {data.get('expired_tokens', 0)}\n"
                text += f"â€¢ Ú©Ù„ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§: {data.get('total_tokens', 0)}\n"
                text += f"â€¢ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ù…Ø±ÙˆØ²: {data.get('daily_usage', 0)} Ø¯Ø±Ø®ÙˆØ§Ø³Øª\n\n"
                
                text += f"ğŸ”‘ **Ø§Ù†ÙˆØ§Ø¹ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§:**\n"
                text += f"â€¢ Ù…Ø¯ÛŒØ±: {data.get('admin_tokens', 0)}\n"
                text += f"â€¢ Ù…Ø­Ø¯ÙˆØ¯: {data.get('limited_tokens', 0)}\n"
                text += f"â€¢ Ú©Ø§Ø±Ø¨Ø±: {data.get('user_tokens', 0)}\n\n"
            else:
                text += "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø± ØªÙˆÚ©Ù†â€ŒÙ‡Ø§\n\n"
            
            text += f"ğŸ• **Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ:** {datetime.now().strftime('%H:%M:%S')}"
            
            keyboard = InlineKeyboardMarkup([
                [
                    InlineKeyboardButton("ğŸ“‹ Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§", callback_data="list_all_tokens"),
                    InlineKeyboardButton("â• ØªÙˆÙ„ÛŒØ¯ ØªÙˆÚ©Ù†", callback_data="create_new_token")
                ],
                [
                    InlineKeyboardButton("ğŸ”’ Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø³ØªØ±Ø³ÛŒ", callback_data="token_manage_permissions"),
                    InlineKeyboardButton("ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ø§Ø³ØªÙØ§Ø¯Ù‡", callback_data="token_usage_report")
                ],
                [
                    InlineKeyboardButton("âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ù…Ù†ÛŒØªÛŒ", callback_data="token_security_settings"),
                    InlineKeyboardButton("ğŸ§¹ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ", callback_data="cleanup_tokens")
                ],
                [
                    InlineKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª", callback_data="download_system_control")
                ]
            ])
            
            await query.edit_message_text(text, reply_markup=keyboard, parse_mode='Markdown')
            
        except Exception as e:
            logger.error(f"Error in show_token_dashboard: {e}")
            await self.handle_error(update, context, e)
    
    async def show_create_token_wizard(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ ØªÙˆÚ©Ù† Ø¬Ø¯ÛŒØ¯"""
        try:
            query = update.callback_query
            await query.answer()
            
            text = "ğŸ” **Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ ØªÙˆÚ©Ù† Ø¬Ø¯ÛŒØ¯**\n\n"
            text += "Ù„Ø·ÙØ§Ù‹ Ù†ÙˆØ¹ ØªÙˆÚ©Ù† Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\n\n"
            
            text += "ğŸ›¡ **ØªÙˆÚ©Ù† Ù…Ø¯ÛŒØ± (Admin):**\n"
            text += "â€¢ Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ù…Ù„ Ø¨Ù‡ ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÛŒØ§Øª\n"
            text += "â€¢ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ùˆ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§\n"
            text += "â€¢ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÛŒØ³ØªÙ…\n"
            text += "â€¢ Ú¯Ø²Ø§Ø±Ø´â€ŒÚ¯ÛŒØ±ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡\n\n"
            
            text += "âš™ï¸ **ØªÙˆÚ©Ù† Ù…Ø­Ø¯ÙˆØ¯ (Limited):**\n"
            text += "â€¢ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¹Ù…Ù„ÛŒØ§Øª Ù…Ø­Ø¯ÙˆØ¯\n"
            text += "â€¢ Ø§ÛŒØ¬Ø§Ø¯ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§\n"
            text += "â€¢ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¢Ù…Ø§Ø± Ø´Ø®ØµÛŒ\n"
            text += "â€¢ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§\n\n"
            
            text += "ğŸ‘¤ **ØªÙˆÚ©Ù† Ú©Ø§Ø±Ø¨Ø± (User):**\n"
            text += "â€¢ Ø¯Ø³ØªØ±Ø³ÛŒ Ù¾Ø§ÛŒÙ‡\n"
            text += "â€¢ Ø§ÛŒØ¬Ø§Ø¯ Ù„ÛŒÙ†Ú© Ø¯Ø§Ù†Ù„ÙˆØ¯\n"
            text += "â€¢ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¢Ù…Ø§Ø± Ù…Ø­Ø¯ÙˆØ¯\n"
            text += "â€¢ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø±ÙˆØ²Ø§Ù†Ù‡ Ù…Ø­Ø¯ÙˆØ¯\n\n"
            
            text += "âš ï¸ **Ù†Ú©ØªÙ‡:** Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¹ ØªÙˆÚ©Ù† Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÛŒØ§Ø² Ú©Ø§Ø±Ø¨Ø± ØµÙˆØ±Øª Ú¯ÛŒØ±Ø¯."
            
            keyboard = InlineKeyboardMarkup([
                [
                    InlineKeyboardButton("ğŸ›¡ Ù…Ø¯ÛŒØ±", callback_data="create_token_admin"),
                    InlineKeyboardButton("âš™ï¸ Ù…Ø­Ø¯ÙˆØ¯", callback_data="create_token_limited")
                ],
                [
                    InlineKeyboardButton("ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±", callback_data="create_token_user")
                ],
                [
                    InlineKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª", callback_data="token_dashboard")
                ]
            ])
            
            await query.edit_message_text(text, reply_markup=keyboard, parse_mode='Markdown')
            
        except Exception as e:
            logger.error(f"Error in show_create_token_wizard: {e}")
            await self.handle_error(update, context, e)
    
    async def process_token_creation(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª ØªÙˆÙ„ÛŒØ¯ ØªÙˆÚ©Ù†"""
        try:
            query = update.callback_query
            await query.answer("Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ„ÛŒØ¯ ØªÙˆÚ©Ù†...")
            
            token_type = query.data.split('_')[2]  # admin, limited, user
            
            # ØªÙˆÙ„ÛŒØ¯ ØªÙˆÚ©Ù† Ø§Ø² Ø·Ø±ÛŒÙ‚ API
            result = await self.create_api_token(token_type)
            
            if result.get('success'):
                token_data = result.get('data', {})
                
                text = f"âœ… **ØªÙˆÚ©Ù† Ø¬Ø¯ÛŒØ¯ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯**\n\n"
                text += f"ğŸ” **Ù†ÙˆØ¹:** {self._get_token_type_name(token_type)}\n"
                text += f"ğŸ†” **Ø´Ù†Ø§Ø³Ù‡:** `{token_data.get('token_id', 'N/A')}`\n"
                text += f"ğŸ“ **Ù†Ø§Ù…:** {token_data.get('name', 'Ø¨Ø¯ÙˆÙ† Ù†Ø§Ù…')}\n"
                text += f"ğŸ“… **ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯:** {token_data.get('created_at', 'Ù†Ø§Ù…Ø´Ø®Øµ')[:16]}\n"
                
                if token_data.get('expires_at'):
                    text += f"â° **Ø§Ù†Ù‚Ø¶Ø§:** {token_data.get('expires_at')[:16]}\n"
                else:
                    text += f"â™¾ **Ø§Ù†Ù‚Ø¶Ø§:** Ø¨Ø¯ÙˆÙ† Ù…Ø­Ø¯ÙˆØ¯ÛŒØª\n"
                
                text += f"\nğŸ”‘ **ØªÙˆÚ©Ù†:**\n`{token_data.get('token', '')}`\n\n"
                
                text += "âš ï¸ **Ù†Ú©Ø§Øª Ù…Ù‡Ù…:**\n"
                text += "â€¢ Ø§ÛŒÙ† ØªÙˆÚ©Ù† Ø±Ø§ Ø¯Ø± Ø¬Ø§ÛŒÛŒ Ø§Ù…Ù† Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯\n"
                text += "â€¢ Ù…Ø±Ø§Ù‚Ø¨ Ø¹Ø¯Ù… Ø§Ù†ØªØ´Ø§Ø± Ø¹Ù…ÙˆÙ…ÛŒ Ø¢Ù† Ø¨Ø§Ø´ÛŒØ¯\n"
                text += "â€¢ Ø¯Ø± ØµÙˆØ±Øª ÙØ±Ø§Ù…ÙˆØ´ÛŒ Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù†ÛŒØ³Øª\n"
                text += "â€¢ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ù‡Ø± Ø²Ù…Ø§Ù† Ø¢Ù† Ø±Ø§ ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯\n\n"
                
                text += f"ğŸ“Š **Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ† ØªÙˆÚ©Ù†:**\n"
                permissions = self._get_token_permissions(token_type)
                for perm in permissions:
                    text += f"â€¢ {perm}\n"
                
                keyboard = InlineKeyboardMarkup([
                    [
                        InlineKeyboardButton("ğŸ“‹ Ú©Ù¾ÛŒ ØªÙˆÚ©Ù†", callback_data=f"copy_token_{token_data.get('token_id', '')}"),
                        InlineKeyboardButton("ğŸ“Š Ø¬Ø²Ø¦ÛŒØ§Øª", callback_data=f"token_details_{token_data.get('token_id', '')}")
                    ],
                    [
                        InlineKeyboardButton("ğŸ”„ ØªÙˆÙ„ÛŒØ¯ Ù…Ø¬Ø¯Ø¯", callback_data="create_new_token"),
                        InlineKeyboardButton("ğŸ“‹ Ù„ÛŒØ³Øª ØªÙˆÚ©Ù†â€ŒÙ‡Ø§", callback_data="list_all_tokens")
                    ],
                    [
                        InlineKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª", callback_data="token_dashboard")
                    ]
                ])
                
            else:
                text = f"âŒ **Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ ØªÙˆÚ©Ù†**\n\n"
                text += f"Ø¹Ù„Øª: {result.get('error', 'Ù†Ø§Ù…Ø´Ø®Øµ')}\n\n"
                text += "Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø¨Ø§ Ù…Ø¯ÛŒØ± Ø³ÛŒØ³ØªÙ… ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯."
                
                keyboard = InlineKeyboardMarkup([
                    [
                        InlineKeyboardButton("ğŸ”„ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯", callback_data=f"create_token_{token_type}"),
                        InlineKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª", callback_data="create_new_token")
                    ]
                ])
            
            await query.edit_message_text(text, reply_markup=keyboard, parse_mode='Markdown')
            
        except Exception as e:
            logger.error(f"Error in process_token_creation: {e}")
            await self.handle_error(update, context, e)
    
    async def show_token_list(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª ØªÙˆÚ©Ù†â€ŒÙ‡Ø§"""
        try:
            query = update.callback_query
            await query.answer()
            
            # Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª ØªÙˆÚ©Ù†â€ŒÙ‡Ø§
            tokens_result = await self.get_all_tokens()
            
            text = "ğŸ“‹ **Ù„ÛŒØ³Øª ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…**\n\n"
            
            if tokens_result.get('success'):
                tokens = tokens_result.get('tokens', [])
                
                if tokens:
                    for i, token in enumerate(tokens, 1):
                        status_icon = "ğŸŸ¢" if token.get('is_active', True) else "ğŸ”´"
                        type_icon = self._get_token_type_icon(token.get('type', 'user'))
                        
                        text += f"{i}. {type_icon} **{token.get('name', f'ØªÙˆÚ©Ù† {i}')}** {status_icon}\n"
                        text += f"   ğŸ· Ù†ÙˆØ¹: {self._get_token_type_name(token.get('type', 'user'))}\n"
                        text += f"   ğŸ†” Ø´Ù†Ø§Ø³Ù‡: `{token.get('token_id', token.get('id', 'N/A'))}`\n"
                        text += f"   ğŸ“… Ø§ÛŒØ¬Ø§Ø¯: {token.get('created_at', 'Ù†Ø§Ù…Ø´Ø®Øµ')[:16]}\n"
                        
                        if token.get('expires_at'):
                            text += f"   â° Ø§Ù†Ù‚Ø¶Ø§: {token.get('expires_at')[:16]}\n"
                        else:
                            text += f"   â™¾ Ø§Ù†Ù‚Ø¶Ø§: Ø¨Ø¯ÙˆÙ† Ù…Ø­Ø¯ÙˆØ¯ÛŒØª\n"
                        
                        text += f"   ğŸ“Š Ø§Ø³ØªÙØ§Ø¯Ù‡: {token.get('usage_count', 0)} Ø¨Ø§Ø±\n"
                        
                        if token.get('last_used_at'):
                            text += f"   ğŸ• Ø¢Ø®Ø±ÛŒÙ† Ø§Ø³ØªÙØ§Ø¯Ù‡: {token.get('last_used_at')[:16]}\n"
                        
                        text += "\n"
                        
                        # Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† ØªØ¹Ø¯Ø§Ø¯ Ù†Ù…Ø§ÛŒØ´
                        if i >= 10:
                            text += f"... Ùˆ {len(tokens) - 10} ØªÙˆÚ©Ù† Ø¯ÛŒÚ¯Ø±\n"
                            break
                else:
                    text += "âŒ Ù‡ÛŒÚ† ØªÙˆÚ©Ù† ÙØ¹Ø§Ù„ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯!\n\n"
                    text += "ğŸ’¡ Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ ÛŒÚ© ØªÙˆÚ©Ù† Ø¬Ø¯ÛŒØ¯ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯."
            else:
                text += f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª ØªÙˆÚ©Ù†â€ŒÙ‡Ø§\n\n"
                text += f"Ø¹Ù„Øª: {tokens_result.get('error', 'Ù†Ø§Ù…Ø´Ø®Øµ')}"
            
            keyboard = InlineKeyboardMarkup([
                [
                    InlineKeyboardButton("ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ", callback_data="list_all_tokens"),
                    InlineKeyboardButton("â• ØªÙˆÚ©Ù† Ø¬Ø¯ÛŒØ¯", callback_data="create_new_token")
                ],
                [
                    InlineKeyboardButton("ğŸ” Ø¬Ø³ØªØ¬Ùˆ", callback_data="search_tokens"),
                    InlineKeyboardButton("ğŸ—‘ Ø­Ø°Ù Ø¯Ø³ØªÙ‡â€ŒØ§ÛŒ", callback_data="bulk_delete_tokens")
                ],
                [
                    InlineKeyboardButton("ğŸ“Š Ø¢Ù…Ø§Ø± Ú©Ø§Ù…Ù„", callback_data="detailed_token_stats"),
                    InlineKeyboardButton("ğŸ’¾ ØµØ§Ø¯Ø±Ø§Øª", callback_data="export_tokens")
                ],
                [
                    InlineKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª", callback_data="token_dashboard")
                ]
            ])
            
            await query.edit_message_text(text, reply_markup=keyboard, parse_mode='Markdown')
            
        except Exception as e:
            logger.error(f"Error in show_token_list: {e}")
            await self.handle_error(update, context, e)
    
    # Helper Methods
    
    def _get_token_type_name(self, token_type: str) -> str:
        """Ø¯Ø±ÛŒØ§ÙØª Ù†Ø§Ù… ÙØ§Ø±Ø³ÛŒ Ù†ÙˆØ¹ ØªÙˆÚ©Ù†"""
        type_names = {
            'admin': 'Ù…Ø¯ÛŒØ± Ú©Ù„',
            'limited': 'Ù…Ø¯ÛŒØ± Ù…Ø­Ø¯ÙˆØ¯', 
            'user': 'Ú©Ø§Ø±Ø¨Ø±',
            'api': 'API',
            'service': 'Ø³Ø±ÙˆÛŒØ³'
        }
        return type_names.get(token_type, 'Ù†Ø§Ù…Ø´Ø®Øµ')
    
    def _get_token_type_icon(self, token_type: str) -> str:
        """Ø¯Ø±ÛŒØ§ÙØª Ø¢ÛŒÚ©ÙˆÙ† Ù†ÙˆØ¹ ØªÙˆÚ©Ù†"""
        type_icons = {
            'admin': 'ğŸ›¡',
            'limited': 'âš™ï¸',
            'user': 'ğŸ‘¤',
            'api': 'ğŸ”‘',
            'service': 'ğŸ”§'
        }
        return type_icons.get(token_type, 'ğŸ”‘')
    
    def _get_token_permissions(self, token_type: str) -> List[str]:
        """Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ÛŒ ØªÙˆÚ©Ù†"""
        permissions = {
            'admin': [
                'Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ù…Ù„ Ø¨Ù‡ ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÛŒØ§Øª',
                'Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ùˆ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§',
                'ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÛŒØ³ØªÙ…',
                'Ú¯Ø²Ø§Ø±Ø´â€ŒÚ¯ÛŒØ±ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡',
                'Ù†Ø¸Ø§Ø±Øª Ø¨Ø± Ø³ÛŒØ³ØªÙ…',
                'Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ùˆ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ'
            ],
            'limited': [
                'Ø§ÛŒØ¬Ø§Ø¯ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯',
                'Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¢Ù…Ø§Ø± Ø´Ø®ØµÛŒ',
                'Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§',
                'Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†'
            ],
            'user': [
                'Ø§ÛŒØ¬Ø§Ø¯ Ù„ÛŒÙ†Ú© Ø¯Ø§Ù†Ù„ÙˆØ¯',
                'Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¢Ù…Ø§Ø± Ù…Ø­Ø¯ÙˆØ¯',
                'Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø´Ø®ØµÛŒ'
            ]
        }
        return permissions.get(token_type, ['Ø¯Ø³ØªØ±Ø³ÛŒ Ù¾Ø§ÛŒÙ‡'])
    
    # API Methods
    
    async def get_token_statistics(self) -> Dict[str, Any]:
        """Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø± ØªÙˆÚ©Ù†â€ŒÙ‡Ø§"""
        try:
            async with aiohttp.ClientSession() as session:
                async with session.get(
                    f"{self.api_url}/api/admin/tokens/stats",
                    headers=self.headers
                ) as response:
                    if response.status == 200:
                        data = await response.json()
                        return {'success': True, 'data': data}
                    else:
                        return {'success': False, 'error': f'HTTP {response.status}'}
        except Exception as e:
            logger.error(f"Error getting token statistics: {e}")
            return {'success': False, 'error': str(e)}
    
    async def get_all_tokens(self) -> Dict[str, Any]:
        """Ø¯Ø±ÛŒØ§ÙØª Ù‡Ù…Ù‡ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§"""
        try:
            async with aiohttp.ClientSession() as session:
                async with session.get(
                    f"{self.api_url}/api/admin/tokens",
                    headers=self.headers
                ) as response:
                    if response.status == 200:
                        data = await response.json()
                        if isinstance(data, list):
                            return {'success': True, 'tokens': data}
                        else:
                            return {'success': True, 'tokens': data.get('tokens', [])}
                    else:
                        return {'success': False, 'error': f'HTTP {response.status}'}
        except Exception as e:
            logger.error(f"Error getting all tokens: {e}")
            return {'success': False, 'error': str(e)}
    
    async def create_api_token(self, token_type: str, name: str = None, expires_in_days: int = None) -> Dict[str, Any]:
        """ØªÙˆÙ„ÛŒØ¯ ØªÙˆÚ©Ù† Ø¬Ø¯ÛŒØ¯"""
        try:
            data = {
                'type': token_type,
                'name': name or f'ØªÙˆÚ©Ù† {token_type} - {datetime.now().strftime("%Y%m%d_%H%M")}'
            }
            
            if expires_in_days:
                data['expires_at'] = (datetime.now() + timedelta(days=expires_in_days)).isoformat()
            
            async with aiohttp.ClientSession() as session:
                async with session.post(
                    f"{self.api_url}/api/auth/token/create",
                    headers=self.headers,
                    json=data
                ) as response:
                    if response.status == 200:
                        result = await response.json()
                        return {
                            'success': True,
                            'data': result
                        }
                    else:
                        error_data = await response.json()
                        return {'success': False, 'error': error_data.get('error', 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ')}
        except Exception as e:
            logger.error(f"Error creating API token: {e}")
            return {'success': False, 'error': str(e)}
    
    async def show_permissions_manager(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ù†Ù…Ø§ÛŒØ´ Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§"""
        try:
            query = update.callback_query
            await query.answer()
            
            text = "ğŸ”’ **Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§**\n\n"
            text += "Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø¯Ø± Ø­Ø§Ù„ ØªÙˆØ³Ø¹Ù‡ Ø§Ø³Øª...\n\n"
            text += "Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø¢ÛŒÙ†Ø¯Ù‡:\n"
            text += "â€¢ ØªÙ†Ø¸ÛŒÙ… Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§ÛŒ Ø³ÙØ§Ø±Ø´ÛŒ\n"
            text += "â€¢ Ú¯Ø±ÙˆÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§\n"
            text += "â€¢ Ú©Ù†ØªØ±Ù„ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ IP\n"
            text += "â€¢ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø²Ù…Ø§Ù†ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ"
            
            keyboard = InlineKeyboardMarkup([[
                InlineKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª", callback_data="token_dashboard")
            ]])
            
            await query.edit_message_text(text, reply_markup=keyboard, parse_mode='Markdown')
            
        except Exception as e:
            logger.error(f"Error in show_permissions_manager: {e}")
            await self.handle_error(update, context, e)
    
    async def show_usage_report(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªÙˆÚ©Ù†â€ŒÙ‡Ø§"""
        try:
            query = update.callback_query
            await query.answer()
            
            # Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡
            stats = await self.get_token_statistics()
            
            text = "ğŸ“Š **Ú¯Ø²Ø§Ø±Ø´ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªÙˆÚ©Ù†â€ŒÙ‡Ø§**\n\n"
            
            if stats.get('success'):
                data = stats.get('data', {})
                text += f"ğŸ“ˆ **Ø¢Ù…Ø§Ø± Ø§Ù…Ø±ÙˆØ²:**\n"
                text += f"â€¢ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ú©Ù„: {data.get('daily_usage', 0)}\n"
                text += f"â€¢ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„: {data.get('active_tokens', 0)}\n"
                text += f"â€¢ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù‡Ø± ØªÙˆÚ©Ù†: {data.get('daily_usage', 0) / max(data.get('active_tokens', 1), 1):.1f}\n\n"
                
                text += f"ğŸ“Š **Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ:**\n"
                text += f"â€¢ Ú©Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡â€ŒÙ‡Ø§: {data.get('total_usage', 0):,}\n"
                text += f"â€¢ Ú©Ù„ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§: {data.get('total_tokens', 0)}\n"
                text += f"â€¢ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ Ù…Ù†Ù‚Ø¶ÛŒ: {data.get('expired_tokens', 0)}\n"
            else:
                text += "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡"
            
            keyboard = InlineKeyboardMarkup([
                [
                    InlineKeyboardButton("ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ", callback_data="token_usage_report"),
                    InlineKeyboardButton("ğŸ“ˆ Ù†Ù…ÙˆØ¯Ø§Ø±", callback_data="usage_chart")
                ],
                [
                    InlineKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª", callback_data="token_dashboard")
                ]
            ])
            
            await query.edit_message_text(text, reply_markup=keyboard, parse_mode='Markdown')
            
        except Exception as e:
            logger.error(f"Error in show_usage_report: {e}")
            await self.handle_error(update, context, e)
    
    async def show_security_settings(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ù†Ù…Ø§ÛŒØ´ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ù…Ù†ÛŒØªÛŒ"""
        try:
            query = update.callback_query
            await query.answer()
            
            text = "ğŸ›¡ **ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ù…Ù†ÛŒØªÛŒ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§**\n\n"
            text += "ğŸ”’ **ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙØ¹Ù„ÛŒ:**\n"
            text += "â€¢ Ø§Ù†Ù‚Ø¶Ø§ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶: Ø¨Ø¯ÙˆÙ† Ù…Ø­Ø¯ÙˆØ¯ÛŒØª\n"
            text += "â€¢ Ø­Ø¯Ø§Ú©Ø«Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡: Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯\n"
            text += "â€¢ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª IP: ØºÛŒØ±ÙØ¹Ø§Ù„\n"
            text += "â€¢ Ù„Ø§Ú¯â€ŒÚ¯ÛŒØ±ÛŒ: ÙØ¹Ø§Ù„\n\n"
            
            text += "âš™ï¸ **ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ±:**\n"
            text += "â€¢ Ù…Ø¯Øª Ø²Ù…Ø§Ù† Ø§Ù†Ù‚Ø¶Ø§ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶\n"
            text += "â€¢ Ø­Ø¯Ø§Ú©Ø«Ø± ØªØ¹Ø¯Ø§Ø¯ Ø§Ø³ØªÙØ§Ø¯Ù‡\n"
            text += "â€¢ Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§ÛŒ IP\n"
            text += "â€¢ Ø³Ø·Ø­ Ù„Ø§Ú¯â€ŒÚ¯ÛŒØ±ÛŒ\n"
            text += "â€¢ Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ"
            
            keyboard = InlineKeyboardMarkup([
                [
                    InlineKeyboardButton("â° ØªÙ†Ø¸ÛŒÙ… Ø§Ù†Ù‚Ø¶Ø§", callback_data="set_default_expiry"),
                    InlineKeyboardButton("ğŸ”¢ Ø­Ø¯ Ø§Ø³ØªÙØ§Ø¯Ù‡", callback_data="set_usage_limit")
                ],
                [
                    InlineKeyboardButton("ğŸŒ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª IP", callback_data="ip_restrictions"),
                    InlineKeyboardButton("ğŸ”” Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§", callback_data="security_alerts")
                ],
                [
                    InlineKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª", callback_data="token_dashboard")
                ]
            ])
            
            await query.edit_message_text(text, reply_markup=keyboard, parse_mode='Markdown')
            
        except Exception as e:
            logger.error(f"Error in show_security_settings: {e}")
            await self.handle_error(update, context, e)
    
    async def show_cleanup_options(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ"""
        try:
            query = update.callback_query
            await query.answer()
            
            text = "ğŸ§¹ **Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§**\n\n"
            text += "âš ï¸ **Ù‡Ø´Ø¯Ø§Ø±:** Ø¹Ù…Ù„ÛŒØ§Øªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø¨Ø±Ú¯Ø´Øªâ€ŒÙ¾Ø°ÛŒØ± Ù†ÛŒØ³ØªÙ†Ø¯!\n\n"
            text += "ğŸ¯ **Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ:**\n\n"
            text += "â€¢ **ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ Ù…Ù†Ù‚Ø¶ÛŒ:** Ø­Ø°Ù ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§ÛŒØ´Ø§Ù† Ú¯Ø°Ø´ØªÙ‡\n"
            text += "â€¢ **ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ ØºÛŒØ±ÙØ¹Ø§Ù„:** Ø­Ø°Ù ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø´Ø¯Ù‡\n"
            text += "â€¢ **ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ Ø¨Ø¯ÙˆÙ† Ø§Ø³ØªÙØ§Ø¯Ù‡:** Ø­Ø°Ù ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ù…Ø¯Øª Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯\n"
            text += "â€¢ **Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„:** Ø­Ø°Ù Ù‡Ù…Ù‡ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ Ø¨Ù‡ Ø¬Ø² Ù…Ø¯ÛŒØ± ÙØ¹Ù„ÛŒ"
            
            keyboard = InlineKeyboardMarkup([
                [
                    InlineKeyboardButton("â° ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ Ù…Ù†Ù‚Ø¶ÛŒ", callback_data="cleanup_expired"),
                    InlineKeyboardButton("ğŸ”´ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ ØºÛŒØ±ÙØ¹Ø§Ù„", callback_data="cleanup_inactive")
                ],
                [
                    InlineKeyboardButton("ğŸ’¤ Ø¨Ø¯ÙˆÙ† Ø§Ø³ØªÙØ§Ø¯Ù‡", callback_data="cleanup_unused"),
                    InlineKeyboardButton("ğŸ—‘ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„", callback_data="cleanup_all")
                ],
                [
                    InlineKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª", callback_data="token_dashboard")
                ]
            ])
            
            await query.edit_message_text(text, reply_markup=keyboard, parse_mode='Markdown')
            
        except Exception as e:
            logger.error(f"Error in show_cleanup_options: {e}")
            await self.handle_error(update, context, e)